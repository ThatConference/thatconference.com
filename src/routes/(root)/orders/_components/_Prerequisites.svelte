<script>
	import { page } from '$app/stores';
	import { goto } from '$app/navigation';
	import lodash from 'lodash';
	import { useMachine } from '@xstate/svelte';

	import { debug } from '$utils/config.public';
	import StepComplete from '$elements/svgs/StepComplete.svelte';
	import Step from '$elements/svgs/Step.svelte';

	import prerequisitesMachine from '../_machines/prerequisites';

	const { state, send } = useMachine(prerequisitesMachine(), {
		devTools: debug.xstate
	});

	const { isEmpty } = lodash;

	$: if ($page.data.user.isAuthenticated) {
		send('AUTHENTICATED', { status: true });
	} else {
		send('AUTHENTICATED', { status: false });
	}

	$: if (!isEmpty($page.data.user.profile)) {
		send('PROFILE_COMPLETED', { status: true });
	} else {
		send('PROFILE_COMPLETED', { status: false });
	}
</script>

<nav aria-label="Progress">
	<ol class="divide-y divide-gray-300 rounded-md border border-gray-300 md:flex md:divide-y-0">
		<li class="relative md:flex md:flex-1">
			{#if $state.context.isAuthenticated}
				<StepComplete stepName="Login" />
			{:else}
				<Step
					step="1"
					isActive={$state.matches('pendingLogin')}
					stepName="Login"
					rel="external"
					href="/login/?r=/orders/summary" />
			{/if}

			<div class="absolute top-0 right-0 hidden h-full w-5 md:block" aria-hidden="true">
				<svg
					class="h-full w-full text-gray-300"
					viewBox="0 0 22 80"
					fill="none"
					preserveAspectRatio="none">
					<path
						d="M0 -2L20 40L0 82"
						vector-effect="non-scaling-stroke"
						stroke="currentcolor"
						stroke-linejoin="round" />
				</svg>
			</div>
		</li>

		<li class="relative md:flex">
			{#if $state.context.hasUserProfile}
				<StepComplete stepName="Profile Completed" />
			{:else}
				<Step
					step="2"
					isActive={$state.matches('pendingProfile')}
					stepName="Profile Completed"
					on:click={() => goto('/my/profiles/primary/')} />
			{/if}

			<div class="absolute top-0 right-0 hidden h-full w-5 md:block" aria-hidden="true">
				<svg
					class="h-full w-full text-gray-300"
					viewBox="0 0 22 80"
					fill="none"
					preserveAspectRatio="none">
					<path
						d="M0 -2L20 40L0 82"
						vector-effect="non-scaling-stroke"
						stroke="currentcolor"
						stroke-linejoin="round" />
				</svg>
			</div>
		</li>

		<li class="relative md:flex">
			<Step
				step="3"
				isActive={$state.matches('pendingVerification')}
				stepName="Verify and Complete Order" />
		</li>
	</ol>
</nav>

<div class="px-4 py-5 sm:p-6">
	{#if ['unAuthenticated', 'pendingLogin'].some($state.matches)}
		<h3 class="text-lg font-medium leading-6 text-gray-900">Please Login</h3>
		<div class="mt-2 max-w-xl text-sm text-gray-500">
			<p>
				Your purchase is attached to the user profile who is logged in. To get started please login,
				and/or create an new account.
			</p>
		</div>
		<div class="mt-3 text-sm">
			<a
				rel="external"
				href="/login/?r=/orders/summary"
				class="font-medium text-thatOrange-400 hover:text-thatOrange-500">
				Login
				<span aria-hidden="true">&rarr;</span>
			</a>
		</div>
	{:else if $state.matches('pendingProfile')}
		<h3 class="text-lg font-medium leading-6 text-gray-900">Full Profile Incomplete</h3>
		<div class="mt-2 max-w-xl text-sm text-gray-500">
			<p>
				Your purchase is attached to the user profile. In order to proceed you need to finish
				creating your user profile.
			</p>
		</div>
		<div class="mt-3 text-sm">
			<a
				href="/my/profiles/primary/"
				class="font-medium text-thatOrange-400 hover:text-thatOrange-500">
				Complete Your Profile
				<span aria-hidden="true">&rarr;</span>
			</a>
		</div>
	{:else if $state.matches('prerequisitesMet')}
		<h3 class="text-lg font-medium leading-6 text-gray-900">Finalize and Complete</h3>
		<div class="mt-2 max-w-xl text-sm text-gray-500">
			<p>
				To fully complete this purchase, upon continue we will redirect your browser to
				https://checkout.stripe.com. This is our credit card processor, Stripe. It's here where you
				will enter your payment details, and finalize this order. Once completed you will be
				redirected back to THAT.us.
			</p>
		</div>
	{/if}
</div>
