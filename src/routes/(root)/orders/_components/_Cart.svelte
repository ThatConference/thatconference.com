<script>
	import { browser, dev } from '$app/environment';
	import { onMount, getContext } from 'svelte';
	import * as Sentry from '@sentry/svelte';
	import { loadStripe } from '@stripe/stripe-js';

	import config from '$utils/config.public';
	import { Cart as CartModal } from '$elements/modals';
	import { Standard as StandardButton } from '$elements/buttons';
	import orderMutations from '$dataSources/api.that.tech/orders/mutations';
	import CartItem from './_CartItem.svelte';
	import { tagEvent } from '$utils/tagEvent';

	const { state, send } = getContext('cart');

	function handleCheckout() {
		Sentry.addBreadcrumb({
			category: 'checkout',
			message: 'handle checkout called',
			level: 'info'
		});

		Sentry.configureScope((scope) => scope.setTransactionName('Handle Checkout'));

		const { eventId, cart } = $state.context;
		Sentry.setContext('cart', cart);

		const lineItems = Object.keys(cart).map((i) => ({
			productId: i,
			quantity: cart[i].qty,
			isBulkPurchase: cart[i].isBulkPurchase
		}));

		Sentry.setContext('lineItems', lineItems);

		if (!dev && browser) {
			tagEvent('redirect-stripe', 'checkout');
		}

		return orderMutations()
			.createCheckoutSession(eventId, lineItems)
			.then((results) => {
				if (results.success) stripe.redirectToCheckout({ sessionId: results.stripeCheckoutId });
				else {
					throw new Error(results.message);
				}
			})
			.then(function (result) {
				// If redirectToCheckout fails due to a browser or network error, you should display the localized error message to your customer using error.message.
				if (result.error) {
					alert(result.error.message);
				}
			})
			.catch(function (error) {
				Sentry.captureException(error);
			});
	}

	let stripe;
	let orderTotal = 0.0;

	$: if ($state.context.cart) {
		const currentCart = $state.context.cart;
		const lineItems = Object.keys(currentCart);

		orderTotal = lineItems.reduce((acc, curr) => {
			const lineTotal = currentCart[curr].price * currentCart[curr].qty;
			return acc + lineTotal;
		}, 0.0);
	}

	onMount(async () => {
		stripe = await loadStripe(config.stripeKey);
	});

	function showBackground(i) {
		const result = i % 2;
		return result != 0;
	}

	function handleErrorContinue() {
		send('CONTINUE');
	}

	function handleReplaceCart() {
		const eventData = {
			...$state.context.addErrorEventData,
			type: 'REPLACE_CART'
		};

		send('REPLACE_CART', eventData);
	}
</script>

<svelte:head>
	<script src="https://js.stripe.com/v3/" async>
	</script>
</svelte:head>

{#if $state.matches('cart.cartError.invalidEvent')}
	<CartModal
		title="Purchasing Limitation"
		text="Currently, we only support purchasing items from one event per order.">
		<div class="flex justify-center space-x-6">
			<StandardButton on:click={handleReplaceCart}>replace</StandardButton>
			<StandardButton on:click={handleErrorContinue}>keep</StandardButton>
		</div>
	</CartModal>
{/if}

{#if $state.matches('cart.cartError.invalidProductType')}
	<CartModal
		title="Purchasing Limitation"
		text="You can purchase an event ticket or a membership but not both. If you have a membership, there is no need for an additional event ticket.">
		<div class="flex justify-center space-x-6">
			<StandardButton on:click={handleReplaceCart}>replace</StandardButton>
			<StandardButton on:click={handleErrorContinue}>keep</StandardButton>
		</div>
	</CartModal>
{/if}

{#if $state.matches('cart.new')}
	<section class="flex flex-col space-y-8">
		<div class="relative">
			<div class="relative flex justify-start">
				<span class="bg-white pr-3 text-lg font-medium text-gray-900">
					Your cart is currently empty.
				</span>
			</div>
		</div>
	</section>
{:else}
	<section class="flex flex-col space-y-8">
		<div class="relative">
			<div class="absolute inset-0 flex items-center" aria-hidden="true">
				<div class="w-full border-t border-gray-300" />
			</div>
			<div class="relative flex justify-start">
				<span class="bg-white pr-3 text-lg font-medium text-gray-900"> Order Details </span>
			</div>
		</div>

		<div class="flex flex-col">
			<div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
				<div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
					<div class="overflow-hidden border-b border-gray-200 shadow sm:rounded-lg">
						<table class="min-w-full divide-y divide-gray-200">
							<thead class="bg-gray-50">
								<tr>
									<th
										scope="col"
										class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
										Event
									</th>
									<th
										scope="col"
										class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
										Item
									</th>
									<th
										scope="col"
										class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
										Description
									</th>
									<th
										scope="col"
										class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
										Price
									</th>
									<th
										scope="col"
										class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
										Quantity
									</th>
									<th scope="col" class="relative px-6 py-3">
										<span class="sr-only">Update</span>
									</th>
									<th
										scope="col"
										class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
										Total
									</th>
								</tr>
							</thead>
							<tbody>
								{#each Object.keys($state.context.cart) as productKey, i (productKey)}
									<CartItem
										eventDetails={$state.context.eventDetails}
										lineItem={$state.context.cart[productKey]}
										showBackground={showBackground(i)}
										on:cart_remove={({ detail: { id } }) =>
											send('REMOVE_ITEM', {
												id
											})}
										on:cart_update={({ detail }) =>
											send('UPDATE_QUANTITY', {
												...detail
											})} />
								{/each}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

		<div class="flex justify-end">
			<div class="text-md font-medium uppercase tracking-wider text-gray-500">
				<span class="px-4">Subtotal:</span>
				<span>$<span>{orderTotal.toFixed(2)}</span></span>
			</div>
		</div>

		<div class="flex justify-end">
			{#if $state.matches('verification.verified')}
				<div class="flex space-x-4">
					<StandardButton on:click={() => history.back()}>Continue Shopping</StandardButton>

					<StandardButton on:click={handleCheckout}>Continue to Complete Purchase</StandardButton>
				</div>
			{:else}
				<div
					class="rounded-md bg-gray-200 px-8 py-2 text-base font-medium leading-6 text-white shadow md:px-10 md:text-lg">
					Purchase Now
				</div>
			{/if}
		</div>
	</section>
{/if}
