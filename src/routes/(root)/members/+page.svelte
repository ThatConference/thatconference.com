<script>
	export let data;

	import SvelteInfiniteScroll from 'svelte-infinite-scroll';
	import { useMachine } from '@xstate/svelte';

	import seoMetaTags from '$utils/seo/metaTags';
	import { debug } from '$utils/config.public';
	import { Waiting } from '$elements';

	import Seo from '$components/Seo.svelte';
	import Hero from '$components/members/Hero.svelte';
	import MemberCard from '$components/members/MemberCard.svelte';
	import ScrollThreshold from '$components/ScrollThreshold.svelte';
	import memberMachine from './_machines/members';

	let { pagedMembers: members } = data;

	const metaTags = ((title = 'These are the geeks you will find at THAT and THAT Conference.') => ({
		title,
		tags: seoMetaTags({
			title,
			description:
				'Our community is made of up geeks and geeklings across the world. Here are just a few.',
			ogImages: {
				twitter: 'members-Twitter.jpg',
				facebook: 'members-Facebook.jpg',
				linkedIn: 'members-LinkedIn.jpg'
			},
			openGraph: {
				type: 'website',
				url: `https://thatconference.com/members`
			}
		})
	}))();

	const { state, send } = useMachine(
		memberMachine({ items: members.members, cursor: members.cursor }),
		{
			devTools: debug.xstate
		}
	);

	let scrollThreshold = 1200;

	function handleLoadMore() {
		send('NEXT');
	}
</script>

<Seo title={metaTags.title} tags={metaTags.tags} />

<ScrollThreshold bind:scrollThreshold />

<main class="overflow-hidden">
	<div class="relative pb-16 md:pb-20 lg:pb-24 xl:pb-32">
		<div class="mx-auto mt-12 max-w-screen-xl px-4 sm:px-6">
			<main>
				<Hero />
				<div class="py-20">
					<div class="px-8">
						<ul
							class="grid grid-cols-1 gap-6 sm:grid-cols-3 md:grid-cols-4
                  lg:grid-cols-5">
							{#each $state.context.items as m, i (m.id)}
								<li class="col-span-1">
									<MemberCard {...m} />
								</li>
							{/each}
							<SvelteInfiniteScroll
								window
								threshold={scrollThreshold}
								on:loadMore={handleLoadMore} />
						</ul>
						{#if ['loadingNext', 'loadedAll'].some($state.matches)}
							<div class="flex flex-grow justify-center py-12">
								<Waiting />
							</div>
						{/if}
					</div>
				</div>
			</main>
		</div>
	</div>
</main>
