<script>
	export let data;

	import { onMount, onDestroy } from 'svelte';
	import { page } from '$app/stores';
	import { browser } from '$app/environment';
	import dayjs from 'dayjs';
	import Clipboard from 'clipboard';

	import seoMetaTags from '$utils/seo/metaTags';
	import Seo from '$components/Seo.svelte';

	import { Standard as StandardLink } from '$elements/links';
	import { Warning, Store, Ticket } from '$elements/svgs';

	let { codes } = data;
	const metaTags = ((title = 'Your Membership - THAT') => ({
		title,
		tags: seoMetaTags({
			title,
			description: 'View your membership settings.',
			openGraph: {
				type: 'website',
				url: `https://thatconference.com/my/settings/membership/`
			},
			nofollow: true,
			noindex: true
		})
	}))();

	let copiedText;
	let clipboard;

	onMount(() => {
		if (browser) {
			clipboard = new Clipboard('.discountCode');

			clipboard.on('success', function () {
				copiedText = 'Copied!';
			});
		}
	});

	onDestroy(() => {
		if (browser) {
			if (clipboard) clipboard.destroy();
		}
	});
</script>

<Seo title={metaTags.title} tags={metaTags.tags} />

<div>
	<header>
		<h2 class="text-xl font-bold leading-6 text-gray-900">Membership Settings</h2>
	</header>

	{#if !$page.data.user.profile?.isMember}
		<div class="mt-8">
			<div class="flex items-center">
				<div class="mr-4">
					<Warning classes="h-12 w-12 text-red-500" />
				</div>

				<h2 class="prose-xl text-gray-500">
					Wait, our records indicate you're not a member yet. Become one today and save on your next
					visit to THAT Conference.
				</h2>
			</div>

			<div class="mt-8 flex">
				<StandardLink href="/membership/">View Membership Options</StandardLink>
			</div>
		</div>
	{:else}
		<div class="mt-8">
			<div class="overflow-hidden bg-white shadow sm:rounded-md">
				<ul class="divide-y divide-gray-200">
					{#each codes as code}
						<li class="cursor-pointer hover:bg-gray-50">
							<!-- svelte-ignore a11y-missing-attribute -->
							<a data-clipboard-text={code.code} class="discountCode">
								<div class="flex items-center px-4 py-4 sm:px-6">
									<div class="flex min-w-0 flex-1 items-center">
										<div class="flex-shrink-0">
											{#if code.type === 'TICKET'}
												<Ticket classes="h-8 w-8 mr-3 text-green-500" />
											{:else}
												<Store classes="h-8 w-8 mr-3 text-green-500" />
											{/if}
										</div>
										<div class="min-w-0 flex-1 items-center px-4 md:grid md:grid-cols-2 md:gap-4">
											<div>
												<p class="text-md truncate font-bold text-thatBlue-800">
													{code.title}
												</p>
											</div>

											<div class="hidden md:block">
												<div>
													<p class="text-sm text-gray-500">
														Created On:
														<time datetime={code.createdAt}>
															{dayjs(code.createdAt).format('MMMM D, YYYY')}
														</time>
													</p>
													<p class="mt-2 flex items-center text-sm font-bold text-thatOrange-400">
														{code.code}
													</p>
												</div>
											</div>
										</div>
									</div>
								</div>
							</a>
						</li>
					{/each}
				</ul>
			</div>
		</div>
	{/if}
</div>
