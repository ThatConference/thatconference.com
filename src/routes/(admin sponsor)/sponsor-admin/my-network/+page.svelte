<script>
	export let data;

	import dayjs from 'dayjs';

	import seoMetaTags from '$lib/seo/metaTags';
	import { csvGenerator } from '$lib/csv';
	import Seo from '$components/Seo.svelte';
	import { Shell } from '$elements/buttons';

	let { contacts } = data;
	const metaTags = ((title = 'Partner Network - THAT') => ({
		title,
		tags: seoMetaTags({
			title,
			description: '',
			openGraph: {
				type: 'website',
				url: 'https://thatconference.com/my/sponsors/my-network'
			},
			noindex: true,
			nofollow: true
		})
	}))();

	function downloadHandler() {
		const tableData = contacts.map((y) => ({
			id: y.id,
			event: y.event.name,
			createdAt: y.createdAt,
			pinNumber: y.partnerPin,
			partnerFirstName: y.partnerContact?.firstName ? y.partnerContact?.firstName : '',
			partnerLastName: y.partnerContact?.lastName ? y.partnerContact.lastName : '',
			firstName: y.member.firstName,
			lastName: y.member.lastName,
			email: y.member.email,
			phone: y.member.phone ? y.member.phone : '',
			city: y.member.city ? y.member.city : '',
			state: y.member.state ? y.member.state : '',
			country: y.member.country ? y.member.country : '',
			company: y.member.company ? y.member.company : '',
			partnersNotes: y.partnersNotes ? y.partnersNotes : ''
		}));

		let tableHeader = [
			'Id',
			'Event',
			'Created At',
			'Pin Number',
			'Partner First Name',
			'Partner Last Name',
			'Attendee First Name',
			'Attendee Last Name',
			'Attendee Email',
			'Attendee Phone',
			'Attendee City',
			'Attendee State',
			'Attendee Country',
			'Attendee Company',
			'Partners Notes'
		];

		let tableKeys = Object.keys(tableData[0]);

		csvGenerator(tableData, tableKeys, tableHeader, 'THAT-My-Network.csv');
	}
</script>

<Seo title={metaTags.title} tags={metaTags.tags} />

<div class="relative mx-auto max-w-screen-xl px-4 sm:px-6 lg:px-8">
	<div class="space-y-12">
		<div
			class="flex items-center justify-between space-y-5 sm:space-y-4 md:max-w-xl lg:max-w-3xl xl:max-w-none">
			<h2 class="text-3xl font-extrabold leading-9 tracking-tight text-thatBlue-800 sm:text-4xl">
				My Network
			</h2>

			<div class="flex">
				<Shell>
					<button
						type="button"
						class="w-full px-8 py-4 text-sm font-medium leading-5"
						on:click={downloadHandler}>
						<span class="text-lg">Download</span>
					</button>
				</Shell>
			</div>
		</div>

		<div class="overflow-hidden bg-white shadow sm:rounded-md">
			<ul class="divide-y divide-gray-200">
				{#each contacts as c}
					<li>
						<div class="flex items-center px-4 py-4 sm:px-6">
							<div class="flex min-w-0 flex-1 items-center">
								<div class="flex-shrink-0">
									<img class="h-12 w-12" src={c.event.logo} alt="" />
								</div>
								<div class="min-w-0 flex-1 px-4 md:grid md:grid-cols-2 md:gap-4">
									<div>
										<p class="truncate text-sm font-medium text-thatBlue-800">
											{c.member.firstName}
											{c.member.lastName}
										</p>
										<p class="mt-2 flex items-center text-sm text-gray-500">
											<svg
												class="mr-1.5 h-5 w-5 flex-shrink-0 text-gray-400"
												xmlns="http://www.w3.org/2000/svg"
												viewBox="0 0 20 20"
												fill="currentColor"
												aria-hidden="true">
												<path
													d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
												<path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
											</svg>
											<span class="truncate">{c.member.email}</span>
										</p>
									</div>
									<div class="hidden md:block">
										<div>
											<p class="text-sm text-gray-900">
												<time datetime="2020-01-07"
													>{dayjs(c.createdAt)
														.tz('America/Chicago')
														.format('dddd, MMMM D, YYYY - h:mm A z')}</time>
											</p>
											<p class="mt-2 flex items-center text-sm text-gray-500">
												<svg
													class="mr-1.5 h-5 w-5 flex-shrink-0 text-green-400"
													xmlns="http://www.w3.org/2000/svg"
													viewBox="0 0 20 20"
													fill="currentColor"
													aria-hidden="true">
													<path
														fill-rule="evenodd"
														d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
														clip-rule="evenodd" />
												</svg>
												Contact exchanged
											</p>
										</div>
									</div>
								</div>
							</div>
							<div>
								<svg
									class="h-5 w-5 text-gray-400"
									xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 20 20"
									fill="currentColor"
									aria-hidden="true">
									<path
										fill-rule="evenodd"
										d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
										clip-rule="evenodd" />
								</svg>
							</div>
						</div>
					</li>
				{/each}
			</ul>
		</div>
	</div>
</div>
